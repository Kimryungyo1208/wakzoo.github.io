
{% extends "background.html" %}
{% block content %}

<script>
 
    // ============ API í‚¤ ì…ë ¥í•˜ëŠ” ê³³ ============
    // OPENAIì—ì„œ ë°œê¸‰ë°›ì€ APIí‚¤ë¥¼ ì´ê³³ì— ì…ë ¥í•˜ì„¸ìš”

    api_key = '123456'

    // APIí‚¤ëŠ” 'sk-' ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤
    // ============ API í‚¤ ì…ë ¥í•˜ëŠ” ê³³ ============



    // ============ ê¸°ì–µ ë ˆë²¨ ì…ë ¥í•˜ëŠ” ê³³ ============
    // ì•„ë˜ì— ì…ë ¥í•œ ìˆ«ìë§Œí¼ ì¸ê³µì§€ëŠ¥ì´ ì´ì „ ëŒ€í™”ë¥¼ ê¸°ì–µí•©ë‹ˆë‹¤
    // ê¸°ì–µ ë ˆë²¨ì´ ë†’ì„ìˆ˜ë¡ ì˜¤ë˜ ëŒ€í™”í•  ë•Œì˜ ë¹„ìš©(í† í°)ì´ ì¦ê°€í•˜ë‹ˆ ì‹ ì¤‘í•˜ê²Œ ì…ë ¥í•˜ì„¸ìš”
    // ë˜í•œ ê¸°ì–µ ë ˆë²¨ì„ ë„ˆë¬´ ë†’ê²Œ ì§€ì •í•  ê²½ìš° ëŒ€í™”ê°€ ê¸¸ì–´ì§€ë©´ ìµœëŒ€ í† í°ì— ë„ë‹¬í•´ GPTê°€ ì‘ë‹µì„ ê±°ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (GPT3.5ëŠ” ìµœëŒ€ í† í° 4096)
    // ì½”ë”©ê³¼ ê°™ì´ ì¥ë¬¸ì˜ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•´ì•¼ í•˜ëŠ” ê²½ìš°ëŠ” ê¸°ì–µ ë ˆë²¨ì„ 5ì´í•˜ë¡œ ì§€ì •í•˜ëŠ” ê±¸ ì¶”ì²œí•´ ë“œë¦½ë‹ˆë‹¤

    memory_level = 10

    // ê¸°ë³¸ê°’ì€ 10ì´ë©° ì¸ê³µì§€ëŠ¥ì´ 10ë²ˆ ì „ê¹Œì§€ì˜ ëŒ€í™”ë¥¼ ê¸°ì–µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
    // ============ ê¸°ì–µ ë ˆë²¨ ì…ë ¥í•˜ëŠ” ê³³ ============




    // ============ ëª¨ë¸ëª… ì…ë ¥í•˜ëŠ” ê³³ ============
    // ì‚¬ìš©í•  GPT ëª¨ë¸ì„ ì…ë ¥í•˜ëŠ” ê³³ì…ë‹ˆë‹¤
    // GPT4 API ì‚¬ìš© í—ˆê°€ë¥¼ ë°›ìœ¼ì‹  ë¶„ì€ GPT4 ëª¨ë¸ì„ ì…ë ¥í•˜ì…”ì„œ ì“°ì‹œë©´ ë©ë‹ˆë‹¤
    // ê¸°ë³¸ê°’ì€ ê°€ì¥ ì‹¼ gpt-3.5-turbo ëª¨ë¸ì…ë‹ˆë‹¤

    using_model = `gpt-4-1106-preview`

    // ============ ëª¨ë¸ëª… ì…ë ¥í•˜ëŠ” ê³³ ============




    // ============ ê¸°ë³¸ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì…ë ¥í•˜ëŠ” ê³³ ============
    // ê¸°ë³¸ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì…ë ¥í•˜ëŠ” ê³³ì…ë‹ˆë‹¤.
    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ëŠ” ê¸°ë³¸ ë©”ì‹œì§€ë³´ë‹¤ ì¢€ ë” ê°•ë ¥í•˜ê²Œ ì ìš©ë©ë‹ˆë‹¤.
    // ì—¬ê¸°ì— ì…ë ¥í•œ ì‹œìŠ¤í…œ ë©”ì‹œì§€ëŠ” í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•  ë•Œ ìë™ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.

    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•  ë•ŒëŠ” ëª…ë ¹í•  ë‚´ìš©ì„ ë§¤ìš° ëª…í™•í•˜ê³  ìì„¸í•˜ê²Œ ì„¤ëª…í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
    // ë˜í•œ ì˜ˆì‹œë¥¼ ë“¤ì–´ì¤„ ë•Œ ëª…ë ¹ì–´ ì´í•´ë ¥ì´ êµ‰ì¥íˆ ë†’ì•„ì§‘ë‹ˆë‹¤.
    // 'ë‹¹ì‹ ì€ ë‚šì‹œê¾¼ì…ë‹ˆë‹¤'ì™€ ê°™ì€ ì§§ì€ ëª…ë ¹ì–´ëŠ” ì˜ ì¸ì‹í•˜ì§€ ëª» í•©ë‹ˆë‹¤.

    default_system = ``

    // ì¤„ë°”ê¿ˆë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    // ============ ê¸°ë³¸ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì…ë ¥í•˜ëŠ” ê³³ ============



    // ============ ë‹µë³€ ëœë¤ì„± ì…ë ¥í•˜ëŠ” ê³³ ============
    // ë‹µë³€ì˜ ëœë¤ì„±ì´ ë†’ì„ìˆ˜ë¡ ë‹µë³€ì´ ë‹¤ì–‘í•˜ê³  ì˜ˆì¸¡í•  ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤.
    // ë°˜ëŒ€ë¡œ ë‹µë³€ì˜ ëœë¤ì„±ì´ ë‚®ì„ìˆ˜ë¡ ê°™ì¸ ì§ˆë¬¸ì—ëŠ” ë¹„ìŠ·í•œ ë‹µë³€ì„ í•  í™•ë¥ ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.
    // ê¸°ë³¸ê°’ì€ 0.7ì´ë©° ìµœëŒ“ê°’ì€ 2ì…ë‹ˆë‹¤.

    random_answer = 0.7;

    // ============ ë‹µë³€ ëœë¤ì„± ì…ë ¥í•˜ëŠ” ê³³ ============



    // ============ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€í•˜ëŠ” ë²• ============
    // ë©”ì‹œì§€ ì•ì— 'ê´€ë¦¬ì :' ë˜ëŠ” 'ì‹œìŠ¤í…œ :'ì„ ë¶™ì´ê³  ì…ë ¥í•˜ë©´ ì‹œìŠ¤í…œ ë©”ì‹œì§€ê°€ ì…ë ¥ë©ë‹ˆë‹¤.
    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ëŠ” GPTê°€ ìŠì§€ ì•Šìœ¼ë©° ì¼ë°˜ ë©”ì‹œì§€ë³´ë‹¤ ì¢€ ë” ê°•ë ¥í•˜ê²Œ ì ìš©ë©ë‹ˆë‹¤.
    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•  ë•ŒëŠ” ëª…ë ¹í•  ë‚´ìš©ì„ ë§¤ìš° ëª…í™•í•˜ê³  ìì„¸í•˜ê²Œ ì„¤ëª…í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
    // ë˜í•œ ì˜ˆì‹œë¥¼ ë“¤ì–´ì¤„ ë•Œ ëª…ë ¹ì–´ ì´í•´ë ¥ì´ êµ‰ì¥íˆ ë†’ì•„ì§‘ë‹ˆë‹¤.
    // ============ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€í•˜ëŠ” ë²• ============

</script>





















<head>
<meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width" />
<meta charset="utf-8">
<title>CHAT GPT 3.5</title>

<style>
    body{
        margin: 0;
        padding: 0;
    }

    .title{
        height: 40px;
        padding: 20px;
        font-size: 30px;
        line-height: 100%;
        width: fit-content;
        margin: 0 auto;
        color: white;
        font-weight: 1000;
    }

    .chat_box {
        position: fixed;
        overflow: auto;
        width: 700px;
        max-width: 90vw;
        margin: 0 auto;
        top: 150px;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
    }

    .message_box {
        background-color: white;
        padding: 10px;
        border-radius: 5px;
        border: 2px solid #fff;
        margin-bottom: 10px;
        padding-left: 15px;
        padding-right: 15px;
        word-break: break-all;
        word-wrap: break-word;
    }

    .option_box {
        width: 720px;
        max-width: calc(80vw + 20px);
        position: fixed;
        bottom: 65px;
        height: 10px;
        left: 50%;
        height: 25px;
        transform: translateX(-50%);
        background-color: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border-radius: 10px;
        border: 2px solid #fff;
        vertical-align: center;
        color: white;
    }

    .chat_input_box {
        width: 700px;
        max-width: 80vw;
        position: fixed;
        bottom: 15px;
        height: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px;
        border-radius: 10px;
        border: 2px solid #fff;
        background-color: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        vertical-align: center;
        font-size: 15px;
        color: white;
        resize: none;
    }

    .code_box{
        position: relative  ;
        word-break: normal;
        word-wrap: normal;
        height: auto;
        width: auto;
        background-color: rgb(40, 40, 40);
        border: 3px solid rgb(80, 80, 80);
        border-radius: 5px;
        padding: 15px;
        color: white;
        white-space: nowrap;
        overflow-x: scroll;
        margin-top: 5px;
        margin-bottom: 5px;
    }

    .clipboard{
        background-color: rgba(255, 255, 255, 0.3);
        position: absolute;
        top: 0;
        right: 0;
        height: 7.5px;
        width: fit-content;
        padding: 2.5px;
        font-size: 7.5px;
        border-radius: 5px;

        line-height: 7.5px;
        text-align: center;
    }

</style>

</head>
<body>
    <div class="title">C&nbsp;H&nbsp;A&nbsp;T&nbsp;&nbsp;&nbsp;G&nbsp;P&nbsp;T</div>
    <div class="chat_box" id="chat_box"></div>
    <textarea class="chat_input_box" id="chat_input_box" type="text" spellcheck="false" placeholder="í”„ë¡¬í”„íŠ¸ ì…ë ¥"></textarea>
</body>

<script>
document.getElementById("chat_input_box").focus();

var dialogue = 'new';

function escapeHtml(text) {
    const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;',
    " ": '&nbsp;',
    '\n': '<br>'
    };

    return text.replace(/[\n &<>"']/g, function(m) { return map[m]; });
}


const message_box = document.getElementById('chat_input_box');
message_box.addEventListener('keydown', function(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
    sendMessage();
    event.preventDefault();
    }
});

function activateLinks(text) {
    var urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, function(url) {
    return '<a href="' + url + '">' + url + '</a>';
    });
}

function CodeClipboard(clicked_element, text) {
    console.log(text);
    const original_text = clicked_element.textContent;
    clicked_element.textContent = 'ğŸ“‹ Copied!';
    navigator.clipboard.writeText(text).then(() => {
        setTimeout(() => {
            clicked_element.textContent = 'ğŸ“‹ Copy';
        }, 1000);
    }).catch((error) => {
        console.error('Failed to copy text: ', error);
        clicked_element.textContent = original_text;
    });
}

function CreateMessage(victim, message, input_info=false) {
    if (input_info == false) {
        var info = {'token': 0, 'message_code': '0'}
    } else { 
        var info = input_info
    }

    const chatDiv = document.getElementById("chat_box");
    
    if (victim == 'gpt') { 
        var MessageDiv = document.getElementById(`message_div-${info['message_code']}`);
    } else if (victim == 'user') { 
        var MessageDiv = document.createElement("div");
        MessageDiv.id = `message_div-${info['message_code']}`;
    }

    if (input_info == false) { var MessageDiv = document.createElement("div") }

    const MessageBox = document.createElement("div");
    MessageBox.id = `${victim}_message_box-${info['message_code']}`;
    MessageBox.className = `message_box`;

    MessageDiv.appendChild(MessageBox);
    chatDiv.appendChild(MessageDiv);

    if (victim == 'user') { 
        var victim_name = 'User'
        MessageBox.style.marginLeft = '10%';
    } else if (victim == 'gpt') { 
        var victim_name = 'ChatGPT' 
        MessageBox.style.marginRight = '10%';
    } else if (victim == 'system') { 
        var victim_name = 'System' 
        MessageBox.style.marginRight = '10%';
    }

    if (typeof info["token"] === 'undefined' || info["token"] == 0) {
        var victim_title = `<p style="font-size: 5px;">${victim_name}</p>`
    } else { 
        if (using_model == 'gpt-3.5-turbo') {
            var victim_title = `<p style="font-size: 5px;">${victim_name} : ${info["token"]} Tokens (ì•½ ${String(info["token"]/1000*0.002*1250).slice(0, 5)}ì›)</p>`
        } else {
            var victim_title = `<p style="font-size: 5px;">${victim_name} : ${info["token"]} Tokens</p>`
        }
    }

    function AddCode(inputcode, language) {
        var code = inputcode;
        var list = splitFirstString(code, "<br>");
        var language_text = list[0];
        var language = language_text.toLowerCase();
        if (language === 'javascript' || language === 'python' || language === 'html' || language === 'mathml' || language === 'svg' || language === 'xml' || language === 'ssml' || language === 'atom' || language === 'rss' || language === 'clike' || language === 'markup' || language === 'regex') {
            var code = code.replace(`${language_text}<br>`, '');
        } else {
            var language = 'python';
        }

        const codeDiv = document.createElement("div");
        codeDiv.className = `code_box`;

        codeDiv.innerHTML = code;

        MessageBox.appendChild(codeDiv);
        
        const clipDiv = document.createElement("div");
        clipDiv.className = `clipboard`;
        clipDiv.textContent = 'ğŸ“‹ Copy';
        codeDiv.appendChild(clipDiv);

        clipDiv.addEventListener('click', function (event) {
            var clicked_element = event.target;
            var parent_element_text = clicked_element.parentElement.innerText.trim().replace("ğŸ“‹ Copy", "").replace("ğŸ“‹ Copied!", "").trimRight('\n');

            CodeClipboard(clicked_element, parent_element_text);
        });

    }

    function AddText(text) {
        const newDiv = document.createElement("div");
        newDiv.innerHTML = activateLinks(text);
        MessageBox.appendChild(newDiv);
    }

    function AddMessage(input_message) {
        let input = input_message.replace(/```<br>/g, '```');
        let arr = input.split('```');
        let Messages = [];
        let Codes = [];
        for (let i = 0; i < arr.length; i++) {
            if (i % 2 == 0) {
            Messages.push(arr[i]);
            } else {
            Codes.push(arr[i]);
            }
        }
        
        let maxLength = Math.max(Messages.length, Codes.length);
        for (let i = 0; i < maxLength; i++) {
            if (i < Messages.length) {
            AddText(Messages[i]);
            }
            if (i < Codes.length) {
            AddCode(Codes[i]);
            }
        }
    }
    MessageBox.innerHTML = `${victim_title}`;
    AddMessage(message);


    MessageBox.style.opacity = 0;
    void MessageBox.offsetWidth;
    MessageBox.style.transition = 'opacity 0.25s';
    MessageBox.style.opacity = 1;
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

if (default_system == '') {
    CreateMessage('gpt', `ì•ˆë…•í•˜ì„¸ìš” CHAT GPTì…ë‹ˆë‹¤!<br>ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?<br><br>ì‚¬ìš© ëª¨ë¸ : ${using_model}<br>ê¸°ì–µ ë ˆë²¨ : ${memory_level}<br>ë‹µë³€ ë¨ë˜ì„± : ${random_answer}`);
} else {
    CreateMessage('gpt', `ì•ˆë…•í•˜ì„¸ìš” CHAT GPTì…ë‹ˆë‹¤!<br>ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?<br><br>ì‚¬ìš© ëª¨ë¸ : ${using_model}<br>ê¸°ì–µ ë ˆë²¨ : ${memory_level}<br>ë‹µë³€ ë¨ë˜ì„± : ${random_answer}<br><br>ê¸°ë³¸ ì‹œìŠ¤í…œ ë©”ì‹œì§€ : ${default_system.replace(/\n/g, '<br>')}`);
}

if (api_key == '') {
    CreateMessage('gpt', `( ê²½ê³  ) API í‚¤ê°€ ì…ë ¥ë˜ì–´ìˆì§€ ì•ŠìŠµë‹ˆë‹¤! íŒŒì¼ì„ ì—´ì–´ OPENAIì—ì„œ ì œê³µë°›ì€ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!`);
}


function ClearMessage() {
    const elements = document.querySelectorAll('.message_box');
    elements.forEach(element => element.remove());
}

function flatten(arr) { // ë¦¬ìŠ¤íŠ¸ë¥¼ ì¸ìë¡œ ë°›ëŠ” í•¨ìˆ˜
    return arr.reduce(function (flat, toFlatten) { // reduce ë©”ì†Œë“œë¥¼ ì´ìš©í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ë¥¼ í•˜ë‚˜ë¡œ í•©ì¹¨
        return flat.concat(Array.isArray(toFlatten) ? flatten(toFlatten) : toFlatten); // concat ë©”ì†Œë“œë¥¼ ì´ìš©í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ë¥¼ í•˜ë‚˜ë¡œ í•©ì¹¨
    }, []);
}

function removeSpaces(str) {
    // ì •ê·œì‹ì„ ì´ìš©í•˜ì—¬ ê³µë°± ì œê±°
    return str.replace(/\s/g, "");
}

function splitFirstString(string, split_str) {
    const idx = string.indexOf(split_str);
    if (idx !== -1) {
        const left = string.substring(0, idx);
        const right = string.substring(idx + 1);
        return [left, right];
    } else {
        return [string];
    }
}

dialogue = [];
if (default_system != '') { 
    systems = [{"role": 'system', "content": default_system}];
} else {
    systems = [];
}
function sendMessage() {
    var send_message = message_box.value;
        if (removeSpaces(send_message) != '') {

            while (dialogue.length > memory_level) { // ë¦¬ìŠ¤íŠ¸ì˜ ê¸¸ì´ê°€ ìµœëŒ€ ê¸¸ì´ë³´ë‹¤ í¬ë©´ ë°˜ë³µ
                dialogue.shift(); // ë¦¬ìŠ¤íŠ¸ì˜ ì²« ë²ˆì§¸ ìš”ì†Œë¥¼ ì œê±°
            }

            message_box.value = '';

            var message_code = Date.now();
            CreateMessage('user', escapeHtml(send_message), {'token': 0, 'message_code': message_code});

            const query = send_message;

            if (removeSpaces(query).substring(0, 4) == 'ê´€ë¦¬ì:' || removeSpaces(query).substring(0, 4) == 'ì‹œìŠ¤í…œ:') {
                const system_query = splitFirstString(query, ':')[1];
                systems.push({"role": 'system', "content": system_query});
                CreateMessage('system', escapeHtml(`ë§ì”€í•˜ì‹  ë‚´ìš©ì´ ì‹œìŠ¤í…œ ë©”ì‹œì§€ì— ë‹¤ìŒ ë‚´ìš©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!\nì‹œìŠ¤í…œ ë©”ì‹œì§€ëŠ” GPTê°€ ìŠì§€ ì•Šìœ¼ë©° ì¼ë°˜ ë©”ì„¸ì§€ë³´ë‹¤ ì¢€ ë” ê°•ë ¥í•˜ê²Œ ì ìš©ë©ë‹ˆë‹¤.\nì‹œìŠ¤í…œ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•  ë•ŒëŠ” ëª…ë ¹í•  ë‚´ìš©ì„ ì˜ˆì‹œë¥¼ ë“¤ì–´ ëª…í™•í•˜ê²Œ ì„¤ëª…í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.`));
            } else {
                
                const now_query = { "role": 'user', "content": query };

                var message_list = [];
                message_list.push(now_query);

                const query_list = systems.concat(flatten(dialogue));
                query_list.push(now_query)
                console.log(query_list);
                const OPENAI_API_KEY = api_key;
                fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + OPENAI_API_KEY
                    },
                    body: JSON.stringify({
                        model: using_model,
                        messages: query_list,
                        temperature: random_answer,
                    })
                })
                
                .then(response => {
                    const response_data = response.json()
                    
                    response_data.then(result => {
                        console.log(result);
            
                        const error = result?.error?.message;
                        if (error == undefined) {
                            const choices = result.choices;
                            const response_message = choices[0].message.content;
                            const used_tokens = result.usage.total_tokens;
                            CreateMessage('gpt', escapeHtml(response_message), {'token': used_tokens, 'message_code': message_code});
                            message_list.push({ "role": 'assistant', "content": response_message });
                            dialogue.push(message_list);
                        } else {
                            const response_message = `ë‹µë³€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì˜¤ë¥˜ ì‚¬ìœ  : ${error})`;
                            CreateMessage('gpt', `ì˜¤ë¥˜ ë°œìƒ : ${escapeHtml(response_message)}`, {'token': 0, 'message_code': message_code});
                            message_list.push({ "role": 'assistant', "content": response_message });
                            dialogue.push(message_list);
                        }
                    });
                })
            }
    }
}
</script>
{% endblock %}
